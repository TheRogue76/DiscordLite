name: CI

on:
  pull_request:
    branches:
      - main
      - develop
  push:
    branches:
      - main
      - develop

env:
  DEVELOPER_DIR: /Applications/Xcode.app/Contents/Developer

jobs:
  swiftlint:
    name: SwiftLint
    runs-on: macos-15
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install SwiftLint
        run: |
          brew install swiftlint

      - name: Run SwiftLint
        run: |
          swiftlint lint --strict --reporter github-actions-logging

  swift-format:
    name: Swift Format
    runs-on: macos-15
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install swift-format
        run: |
          brew install swift-format

      - name: Check formatting
        run: |
          # Check if any Swift files need formatting
          UNFORMATTED=$(swift-format lint --recursive DiscordLite DiscordLiteTests 2>&1 | grep -c "would" || true)
          if [ "$UNFORMATTED" -gt 0 ]; then
            echo "❌ Found $UNFORMATTED file(s) with formatting issues"
            echo "Run 'swift-format format --in-place --recursive DiscordLite DiscordLiteTests' locally to fix"
            swift-format lint --recursive DiscordLite DiscordLiteTests
            exit 1
          else
            echo "✅ All files are properly formatted"
          fi

  test:
    name: Unit Tests
    runs-on: macos-15
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Select Xcode version
        run: |
          sudo xcode-select -s /Applications/Xcode.app

      - name: Show Xcode version
        run: |
          xcodebuild -version

      - name: Show Swift version
        run: |
          swift --version

      - name: Cache Swift Package Manager
        uses: actions/cache@v4
        with:
          path: |
            .build
            ~/Library/Caches/org.swift.swiftpm
          key: ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-spm-

      - name: Resolve dependencies
        run: |
          xcodebuild -resolvePackageDependencies -project DiscordLite.xcodeproj -scheme DiscordLite

      - name: Build for testing
        run: |
          xcodebuild clean build-for-testing \
            -project DiscordLite.xcodeproj \
            -scheme DiscordLite \
            -destination 'platform=macOS' \
            -configuration Debug \
            CODE_SIGNING_ALLOWED=NO \
            | xcpretty && exit ${PIPESTATUS[0]}

      - name: Run tests
        run: |
          xcodebuild test-without-building \
            -project DiscordLite.xcodeproj \
            -scheme DiscordLite \
            -destination 'platform=macOS' \
            -configuration Debug \
            CODE_SIGNING_ALLOWED=NO \
            | xcpretty && exit ${PIPESTATUS[0]}

      - name: Generate test report
        if: always()
        run: |
          if [ -d "$(xcodebuild -project DiscordLite.xcodeproj -showBuildSettings | grep -m 1 "BUILD_DIR" | awk '{print $3}')" ]; then
            echo "✅ Tests completed"
          fi

  build:
    name: Build
    runs-on: macos-15
    needs: [swiftlint, swift-format, test]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Select Xcode version
        run: |
          sudo xcode-select -s /Applications/Xcode.app

      - name: Cache Swift Package Manager
        uses: actions/cache@v4
        with:
          path: |
            .build
            ~/Library/Caches/org.swift.swiftpm
          key: ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-spm-

      - name: Build Release
        run: |
          xcodebuild clean build \
            -project DiscordLite.xcodeproj \
            -scheme DiscordLite \
            -destination 'platform=macOS' \
            -configuration Release \
            CODE_SIGNING_ALLOWED=NO \
            | xcpretty && exit ${PIPESTATUS[0]}

  status-check:
    name: Status Check
    runs-on: macos-15
    needs: [swiftlint, swift-format, test, build]
    if: always()
    steps:
      - name: Check job results
        run: |
          if [ "${{ needs.swiftlint.result }}" != "success" ] || \
             [ "${{ needs.swift-format.result }}" != "success" ] || \
             [ "${{ needs.test.result }}" != "success" ] || \
             [ "${{ needs.build.result }}" != "success" ]; then
            echo "❌ CI checks failed"
            exit 1
          else
            echo "✅ All CI checks passed"
          fi
